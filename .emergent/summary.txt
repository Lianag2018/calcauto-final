<analysis>**original_problem_statement:**
The user wants to continue developing a mobile application for iOS and Android named CalcAuto AiPro, which functions as a comprehensive vehicle financing calculator.

The primary goal is to build an advanced inventory management system featuring automated invoice scanning. This involves a robust, multi-layered parsing system. The main challenge has been the accuracy of the OCR (Optical Character Recognition) on real-world invoices, leading to incorrect data extraction for critical fields like VIN, stock number, and color code.

The user has decided to switch from GPT-4 Vision to Google Cloud Vision for the OCR part of the pipeline to improve accuracy and reduce costs, while keeping the existing backend logic for parsing and validation.

**PRODUCT REQUIREMENTS:**
*   **Data Isolation (Multi-Tenancy):** Completed.
*   **Save Submissions to Server:** Completed.
*   **Smart Contact Management (Upsert):** Completed.
*   **Logout Functionality:** Completed.
*   **Production Deployment:** Completed and identified (Vercel/Render).
*   **Admin Panel (P0):** Completed.
*   **Inventory Management (P0):** Implemented, but workflow issues were discovered and fixed.
*   **Invoice Scanning (P0):** Implemented. The focus is now on replacing GPT-4 Vision with Google Cloud Vision for better accuracy and lower cost.
*   **Calculator & Inventory Integration (P1):** Implemented and verified by the user.

**User's preferred language**: French. The next agent MUST respond in French.

**what currently exists?**
A full-stack application with a React Native (Expo) frontend and a FastAPI backend. The application is deployed in two separate environments:
1.  **Production**: Frontend on Vercel (), backend on Render (), using a MongoDB Atlas database. This is the environment the user tests with on their mobile device.
2.  **Development**: An isolated preview environment provided by the platform, where the agent works.

This separation caused significant confusion, which has now been resolved. The agent understands that for the user to see changes, the code must be pushed to GitHub, which then triggers automatic deployments to Vercel and Render.

The backend contains a sophisticated invoice scanning pipeline. It currently uses a CamScanner-style image preprocessing step with OpenCV, followed by multi-zone analysis with GPT-4 Vision. The agent is about to replace GPT-4 Vision with Google Cloud Vision.

**Last working item**:
*   **Last item agent was working:** The agent was guiding the user through the process of obtaining a Google Cloud Vision API key. The user successfully created the key and provided it to the agent. The next step is to integrate this key and the Google Cloud Vision SDK into the backend pipeline.
*   **Status:** IN PROGRESS
*   **Agent Testing Done:** N
*   **Which testing method agent to use?** backend testing agent. After implementing the Google Cloud Vision integration, the agent should create/update a test in  to use a real invoice image and verify that the new OCR pipeline works correctly.
*   **User Testing Done:** N

**All Pending/In progress Issue list**:
*   **Issue 1: OCR and VIN Correction Accuracy for Real Invoices (P0)**
    *   **Description**: This is the main recurring issue. The current GPT-4 Vision-based pipeline still makes errors on handwritten text (stock number) and similar printed characters (S vs 5, K vs X). The agreed-upon solution is to switch to Google Cloud Vision for its superior OCR capabilities, especially for handwriting.
    *   **Next debug checklist**:
        1.  The user has provided the Google Cloud Vision API key. Store it securely in the backend environment.
        2.  Call the  tool to get the correct installation and implementation steps for the Google Cloud Vision API.
        3.  Modify  and  to replace the GPT-4 Vision call with a call to the Google Cloud Vision API for text detection.
        4.  Ensure the raw text output from Google Vision is fed into the existing parsing logic in .
        5.  Test the new pipeline with the user's problematic invoices.
    *   **Why fix this issue and what will be achieved with the fix?**: To achieve zero error reliability, reduce operational costs by ~85%, and improve user trust by correctly parsing all invoice fields, including handwritten ones.
    *   **Status**: IN PROGRESS
    *   **Is recurring issue?**: Y
    *   **Should Test frontend/backend/both after fix?**: backend

**In progress Task List**:
*   **Task 1: Integrate Google Cloud Vision for OCR (P0)**
    *   **Where to resume**: The user has provided the API Key: . The agent needs to start the implementation.
    *   **What will be achieved with this?**: A more accurate, faster, and significantly cheaper invoice scanning pipeline.
    *   **Status**: NOT STARTED (Planning and key acquisition are complete, implementation is next).
    *   **Should Test frontend/backend/both after fix?**: backend
    *   **Blocked on something**: Nothing.

**Upcoming and Future Tasks**
*   **(P1) Finalize Frontend Refactoring Migration:** The logic in  is still monolithic. The migration plan exists in  but has not been executed.
*   **(P2) Add Frontend Warning for Corrected VINs:** Add a visual indicator in the review modal for auto-corrected VINs.
*   **(P3) Refactor :** Split the monolithic file into a  directory structure.
*   **(P3) Admin Dashboard for Parsing Metrics:** Create a frontend dashboard to visualize data from the  endpoint.
*   **(P3) Finalize App Store / Play Store Build Process.**

**Completed work in this session**
- **Diagnosed and Resolved Environment Mismatch:** Identified that the user was testing on a Vercel/Render production environment while the agent was working in a separate preview environment. This was the root cause of many lost work and not updating issues.
- **Implemented CamScanner-style Image Preprocessing:** Added an OpenCV pipeline in  to automatically detect document contours, correct perspective, remove shadows, and enhance contrast before OCR.
- **Enhanced GPT-4 Vision Prompts:** Iteratively improved prompts with multi-zone analysis (sending zoomed-in image crops of critical areas) and specific instructions to handle common OCR confusions.
- **Added Robust Server-Side VIN Correction:** Implemented logic in  to automatically correct common, specific OCR errors (e.g., forcing a VIN's year character to be 'S' if it's read as '8' and the resulting year is impossible).
- **Fixed Calculator-Inventory Integration:** Debugged why newly scanned vehicles weren't appearing in the calculator, which was ultimately due to the environment mismatch. The feature itself was working correctly.
- **Guided User to Obtain Google Cloud Vision API Key:** Successfully walked the user through the Google Cloud console to create a project, enable the API, and generate an API key for the new OCR integration.
- **Removed Accessory Prices:** Modified the backend to set accessory prices to 0, as requested by the user.

**Earlier issues found/mentioned but not fixed**
*   **Issue 1: Large Monolithic Files (, )**
    *   **Debug checklist**: Follow the plan in  for the frontend. For the backend, plan a split of  into a  directory.
    *   **Why to solve this issue and what will be achieved with this?**: Improve code maintainability, readability, and scalability.
    *   **Should Test frontend/backend/both after fix?**: both
    *   **Is recurring issue?**: Y

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork**: OCR Accuracy
- **Recurrence count**: High (This has been the primary focus of the entire interaction).
- **Status**: IN PROGRESS (The switch to Google Cloud Vision is the next major attempt at a permanent fix).

**Code Architecture**


**Key Technical Concepts**
- **Hybrid OCR Strategy:** Using a highly accurate but dumb OCR engine (Google Cloud Vision) to extract raw text, then feeding that text to a separate, intelligent parsing layer (existing regex-based parser) to structure the data. This is cheaper and more accurate than using a single vision-language model for both tasks.
- **OpenCV Image Preprocessing:** Implementing a CamScanner-style pipeline to automatically clean and enhance images (perspective correction, contrast enhancement, shadow removal) before sending them for OCR.
- **Environment Separation (Prod vs. Dev):** Understanding that the user's production environment (Vercel/Render) is separate from the agent's development environment, and that code must be pushed via Save to Github to be deployed.

**key DB schema**
- **inventory**: 
- **users**: 

**All files of reference**
- : The main application file where the Google Vision integration will be orchestrated.
- : Contains the  (CamScanner) function. The new Google Vision call will likely be added here.
- : Contains the regex logic that will process the text output from Google Vision.
- : Contains the advanced VIN correction logic.
- : The screen from which the user initiates the invoice scan.

**Areas that need refactoring**:
- ****: A ~4800-line monolithic file that needs to be broken down into a  structure.
- ****: A ~3000-line monolithic file with a prepared but unexecuted migration plan.

**key api endpoints**
- : The core endpoint that receives the invoice image and runs the entire processing pipeline. This is the endpoint that needs to be modified.
- : Fetches the user's inventory, filtered by .
- : Saves a new vehicle to the inventory.

**Critical Info for New Agent**
1.  **Parlez FranÃ§ais:** All communication with the user MUST be in French.
2.  **IMMEDIATE TASK: Integrate Google Cloud Vision.** Your first priority is to use the provided API key () to replace the GPT-4 Vision OCR call with Google Cloud Vision. Use the  tool to ensure you use the correct SDK and implementation pattern. The goal is: Image -> Preprocessing (already done) -> **Google Vision OCR** -> Raw Text -> Existing Parser ().
3.  **TWO ENVIRONMENTS EXIST.** The user tests on their production app, which is deployed on **Vercel** (frontend) and **Render** (backend). You work in a separate preview environment. To deploy your changes for the user to test, you MUST instruct them to use the **Save to Github** button. This is non-negotiable and the key to a smooth workflow.
4.  **The New Pipeline is HYBRID:** Do NOT use Google Cloud Vision for context or JSON extraction. Use it ONLY for OCR (detecting text on the document). The existing code in  is responsible for taking that raw text and extracting the structured data (VIN, EP, PDCO, etc.). This is the user's explicit wish.

**documents and test reports created in this job**
None.

**Last 10 User Messages and any pending HUMAN messages**
- The user confirmed their understanding of the hybrid Google Vision + existing parser approach.
- The agent provided step-by-step instructions for the user to navigate the Google Cloud Console.
- The user followed the instructions, sharing screenshots at each step for verification.
- The agent guided the user through creating a project, enabling the Vision API, handling billing setup, and creating credentials.
- After an issue with a service account key, the agent pivoted to a simpler API Key method.
- The user successfully created the API key.
- **Pending:** The user sent the API key and is waiting for the agent to implement the integration.

**Project Health Check:**
*   **Broken:** The frontend Expo development environment in the cloud container remains unstable (,  errors). This blocks live UI testing for the agent but is not a blocker for the user, who tests on their deployed production app.
*   **Mocked:** None.

**3rd Party Integrations**
*   **OpenAI GPT-4o**: Currently used for OCR. **TO BE REPLACED.**
*   **Google Cloud Vision**: **TO BE INTEGRATED.** The user has provided an API key.
*   **usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing.**: Primary parser for native PDF files.
*   ****: Core open-source OCR engine (used as a fallback/test).
*   ****: Used for the CamScanner-style image pre-processing.

**Testing status**
- **Testing agent used after significant changes:** NO (in this session).
- **Troubleshoot agent used after agent stuck in loop:** NO
- **Test files created:** None new. Existing tests in  were run frequently.
- **Known regressions:** The frontend scan flow was temporarily broken when the agent made changes and the user deployed them. The agent reverted the frontend files, and the user pushed the revert to production, fixing the issue. The backend improvements remained.

**Credentials to test flow:**
- **User:** 
- **Password:** 
- **Note**: These credentials are for the user's account on the production environment.

**What agent forgot to execute**
The agent did not forget to execute any major tasks. The entire session was a deep, iterative debugging and improvement cycle focused on the single most critical problem reported by the user: OCR accuracy. The agent correctly prioritized this over other backlog items like refactoring.</analysis>
