<analysis>**original_problem_statement:**
The user wants to continue developing a mobile application for iOS and Android named CalcAuto AiPro, which functions as a comprehensive vehicle financing calculator.

The initial scope was to fix backend crashes and deploy the application. This has since expanded to include several critical features requested by the user, most importantly an advanced inventory management system with automated invoice scanning.

**PRODUCT REQUIREMENTS:**
*   **Data Isolation (Multi-Tenancy):** Each user must only have access to their own data. (Completed)
*   **Save Submissions to Server:** Calculator submissions must be saved to the user's account. (Completed)
*   **Smart Contact Management (Upsert):** Avoid creating duplicate contacts. (Completed)
*   **Logout Functionality:** Provide a clear logout option. (Completed)
*   **Production Deployment:** Deploy the application to a live environment. (Completed)
*   **Admin Panel (P0):** An administration panel for the super-user to view all registered users and manage their access. (Completed)
*   **Inventory Management (P0):** A system to manage vehicle inventory. (Partially Implemented)
    *   Create a database and API to store detailed vehicle information. (Completed)
    *   Build a UI to view, filter, and manage the inventory. (Completed)
*   **Invoice Scanning (P0):** A feature to scan a vehicle invoice (photo or PDF) and automatically populate the inventory. The user has explicitly rejected a pure AI approach and has provided a detailed specification for a structured parser. (In Progress)
    *   **Methodology:** The system MUST use a structured parser ( + ) as the primary method for extracting data from FCA invoices.
    *   **Fallback:** An AI Vision model (GPT-4o) should ONLY be used as a fallback if the structured parser fails.
    *   **Data Enrichment:** The system must decode the VIN (for year/brand) and the FCA product code (for model/trim) to enrich the data.
    *   **Review & Correct:** After parsing, the user must be shown a review modal with all extracted data in editable fields, allowing them to correct any errors before saving to the database.
*   **Calculator & Inventory Integration (P1):** In the main calculator, allow the user to select a vehicle from their inventory (filtered by brand), which should automatically fill in the vehicle's price and suggest applicable financing programs. (Partially Implemented)

**User's preferred language**: French (fr). The next agent MUST respond in French.

**what currently exists?**
A full-stack application with a React Native (Expo) frontend deployed on Vercel and a FastAPI backend deployed on Render, connected to a MongoDB Atlas database. The Admin Panel, basic Inventory Management (view/add/delete), and user authentication are complete.

The invoice scanning feature has a complete frontend flow, including an upload button and a detailed review and correct modal. The backend contains an **incorrect, AI-first** implementation that the user has rejected. The user has provided a superior, detailed code example for a **structured, regex-based parser** that must be implemented.

The calculator screen has been updated to show a list of available inventory vehicles, filtered by the selected brand.

**Last working item**:
*   Last item agent was working: The agent acknowledged their flawed AI-first approach to invoice parsing after the user provided a detailed explanation and Python code for a much better structured (regex-based) parser. The agent's last action was to agree to rewrite the parsing logic using this correct, user-specified method.
*   Status: IN PROGRESS
*   Agent Testing Done: N
*   Which testing method agent to use? both. First, use a backend testing method (e.g.,  script) to validate the new structured parser endpoint in  against the invoice images the user has provided. Once the backend logic is confirmed to be accurate, use the frontend testing agent to verify the end-to-end flow: uploading an invoice, seeing the correct data in the review modal, and saving it to the inventory.
*   User Testing Done: N

**All Pending/In progress Issue list**:
*   **Issue 1: Invoice Parser is Inefficient and Incorrect (P0)**
    *   **Attempted fixes:** The agent first built a slow and inaccurate parser relying solely on GPT-4 Vision. After multiple user corrections, the agent finally understood that a structured, regex-based approach is required.
    *   **Next debug checklist**:
        1.  Open .
        2.  Locate the  endpoint and its related functions.
        3.  Completely **replace the current logic with the structured parser code** provided by the user in chat message #360. This involves using  to extract text and  to find specific fields (VIN, E.P., PDCO, PREF, Holdback, options).
        4.  Implement the  function exactly as specified by the user (remove the first '0' and the last two digits). Apply this to all financial fields.
        5.  Ensure the business logic is correct:  is  directly, and  is  directly.  is extracted but not used in cost calculations.
        6.  The new endpoint should first attempt this structured parsing. Only if it fails should it fall back to the AI model.
    *   **Why fix this issue and what will be achieved with the fix?**: This is the most critical feature for the user. Fixing it will deliver a fast, accurate, and low-cost method for automating inventory entry, which was the user's original vision.
    *   **Status**: IN PROGRESS
    *   **Is recurring issue?**: Y
    *   **Should Test frontend/backend/both after fix?**: both
    *   **Blocked on other issue**: None

**In progress Task List**:
*   **Task 1: Implement the Structured (Regex-based) Invoice Parser (P0)**
    *   **Where to resume**: In , using the complete Python code example provided by the user in message #360 to rewrite the invoice parsing functionality.
    *   **What will be achieved with this?**: A fast, accurate, and cheap invoice parsing system that meets the user's explicit and repeated requirements.
    *   **Status**: NOT STARTED (The agent acknowledged the need but hasn't written the code yet).
    *   **Should Test frontend/backend/both after fix?**: backend
    *   **Blocked on something**: None

**Upcoming and Future Tasks**
*   **(P1) Finalize Calculator-Inventory Integration:** The UI is built. The final step is to test and ensure that clicking a vehicle in the calculator's inventory list correctly populates its  into the Prix du v√©hicule form field.
*   **(P2) Integrate Financing Programs:** When a vehicle is selected in the calculator, automatically suggest or apply the relevant financing programs (e.g., consumer cash, special interest rates) that have been pre-loaded.
*   **(P3) Refactor :** The main calculator file () is over 1800 lines and should be broken down into smaller, reusable components.
*   **(P3) Finalize App Store / Play Store Build Process:** Prepare the app for native mobile deployment by creating build configurations and binaries (/).

**Completed work in this session**
- **Frontend Crash Resolved:** Fixed the Expo development server crash loop.
- **Invoice Review Modal:** Implemented a crucial UI modal that allows the user to review and correct all data parsed from an invoice before saving it. Made the  field editable for manual adjustments.
- **Duplicate Vehicle Prevention:** Added backend validation to block the creation of new inventory items if the  or  already exists.
- **Calculator-Inventory UI:** Successfully integrated a filterable inventory list into the calculator screen, allowing users to see available vehicles of a selected brand.
- **Corrected Business Logic:** Refined the backend logic to use  as the vehicle's cost and  as the , and to extract  as an informational field rather than using it in calculations.
- **Improved Data Decoding:** Enhanced the VIN and product code lookup tables to correctly identify Jeep Gladiator models.
- **UI Cleanup:** Removed the confusing Total Potential Profit aggregation from the inventory screen, as requested by the user.

**Earlier issues found/mentioned but not fixed**
*   None, all have been captured in the pending/upcoming lists.

**Known issue recurrence from previous fork**
*   Not applicable.

**Code Architecture**
scan-invoice

**Key Technical Concepts**
- **Frontend:** React Native (Expo), Expo Router, , React Context API.
- **Backend:** Python, FastAPI, Motor (async MongoDB), .
- **Parsing:** **The key challenge is shifting from a failed AI-first approach to a structured, regex-based parser using , as mandated by the user.** AI should only be a fallback.
- **Authentication:** JWT-based.
- **Deployment:** Render (Backend), Vercel (Frontend), MongoDB Atlas (DB).

**key DB schema**
- **users**: 
- **inventory**: 
- **vehicle_options**: 
- **fca_product_codes**: 

**changes in tech stack**
- The use of  is now required for the backend parser.

**All files of reference**
- : The file requiring the most critical change (implementing the new regex parser).
- : Contains the completed UI for the invoice review modal.
- : Contains the calculator-inventory integration UI.
- The user's chat message #360, which contains the complete and correct Python code for the structured invoice parser.

**Areas that need refactoring**:
- : The invoice scanning logic must be completely rewritten.
- : This file is over 1800 lines long and is difficult to maintain. It should be broken down into smaller components.

**key api endpoints**
- : The endpoint that needs to be rewritten to use the new structured parser. It should take an image/PDF file and return the parsed JSON data for the review modal, without saving to the DB.
- : The endpoint that saves the (user-reviewed and corrected) vehicle data to the database. It already has duplicate prevention logic.
- : Used to update existing inventory items.
- : Fetches the list of all inventory items for the current user.

**Critical Info for New Agent**
1.  **IMPLEMENT THE REGEX PARSER:** Your absolute first priority is to implement the structured, regex-based invoice parser in . The user has provided the exact Python code to use in message #360. Do not use the old, flawed GPT-4 Vision approach. Your job is to integrate the user's proven code into the FastAPI endpoint.
2.  **SIMPLE BUSINESS LOGIC:** Do not overcomplicate calculations. . .  is for information only. The user must be able to edit these values in the review modal before saving.
3.  **FOLLOW THE USER'S LEAD:** The user has demonstrated deep technical knowledge and a clear vision for the parsing logic. Trust their specifications and the code they provided. Do not deviate.

**documents and test reports created in this job**
- 

**Last 10 User Messages and any pending HUMAN messages**
- The last 10+ messages consist of the user expressing frustration with the agent's flawed AI parser, and then providing a detailed, correct solution via a ChatGPT transcript. The user is waiting for the agent to implement this correct solution.
- : Provides an image snippet showing the Subtotal Excluding Taxes line to add to the parser's patterns. (PENDING)
- : Asks if the agent can restart/re-run now. (PENDING)
- : go - instructing the agent to proceed with the correct implementation. (PENDING)
- : **(CRITICAL)** Provides the full ChatGPT conversation transcript that explains exactly how to build a robust, regex-based parser, including full Python code. This is the blueprint for the next step. (PENDING IMPLEMENTATION)
- : Clarifies that  for holdback means .
- : Confirms the universal decoding rule for financial numbers on the invoice.
- : Criticizes the agent's complex calculations and simplifies the logic:  is the cost, period.
- : Provides an annotated invoice image to show the agent it was calculating  incorrectly instead of extracting the written value.

**Project Health Check:**
*   **Broken:** The core backend invoice parsing logic in  is fundamentally incorrect and does not meet user requirements. It must be replaced with the user-provided regex solution.
*   **Mocked:** None.

**3rd Party Integrations**
*   **OpenAI GPT-4o / Vision**: Should be demoted to a **fallback** mechanism for invoice parsing, used only when the primary regex parser fails.
*   **pdfplumber**: A required dependency for the new structured parser.
*   **Render**: Hosts the FastAPI backend.
*   **Vercel**: Hosts the Expo web frontend.
*   **MongoDB Atlas**: Hosts the production database.

**Testing status**
- Testing agent used after significant changes: YES (but for UI validation, not the flawed backend logic).
- Troubleshoot agent used after agent stuck in loop: NO
- Test files created: []
- Known regressions: None.

**Credentials to test flow:**
- **User:** 
- **Password:** 

**What agent forgot to execute**
The agent repeatedly failed to adopt the user's clear and correct specification for a structured, regex-based parser. Instead, the agent wasted significant time trying to patch a flawed AI-first approach, leading to user frustration. The primary task of implementing the user's provided Python code for the parser remains un-executed.</analysis>
