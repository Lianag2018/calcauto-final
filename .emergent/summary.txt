<analysis>**original_problem_statement:**
The user wants to continue developing a mobile application for iOS and Android named CalcAuto AiPro, which functions as a comprehensive vehicle financing calculator.

The primary goal is to build an advanced inventory management system featuring automated invoice scanning. The user has rejected a simple AI-centric approach and provided detailed, evolving technical specifications for a robust, multi-layered parsing system.

**PRODUCT REQUIREMENTS:**
*   **Data Isolation (Multi-Tenancy):** Completed.
*   **Save Submissions to Server:** Completed.
*   **Smart Contact Management (Upsert):** Completed.
*   **Logout Functionality:** Completed.
*   **Production Deployment:** Completed.
*   **Admin Panel (P0):** Completed.
*   **Inventory Management (P0):** Partially Implemented.
    *   Database and basic API/UI: Completed.
*   **Invoice Scanning (P0):** The core task, which has undergone multiple architectural shifts and is now implemented and hardened.
    *   **Architecture:** A multi-layered, open-source pipeline with an AI fallback.
    *   **Level 1 (PDFs):** Use usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing. + . (Implemented)
    *   **Level 2 (Images):** Use a simplified  +  global OCR pipeline. (Implemented)
    *   **Level 3 (Fallback):** An optimized GPT-4 Vision model is used if the open-source pipeline's confidence score is below 60. (Implemented)
    *   **Validation & Decision Logic:**
        *   Score >= 85: Auto-approved.
        *   60 <= Score < 85: Requires user review in the frontend modal.
        *   Score < 60: Triggers Vision fallback.
        *   Golden Rule: The system blocks any save if critical data (VIN, EP, PDCO) is invalid, regardless of score. (Implemented)
    *   **Review & Correct:** The final parsed data is presented in an editable modal for user review before saving. (Frontend part exists, integration needs verification).
*   **Calculator & Inventory Integration (P1):** Partially Implemented.

**User's preferred language**: French. The next agent MUST respond in French.

**what currently exists?**
A full-stack application with a React Native (Expo) frontend and a FastAPI backend using MongoDB. The backend has been significantly refactored from a monolithic  into a modular architecture (, , , ).

The core invoice scanning feature is now implemented with a robust, multi-layered pipeline that prioritizes a free, open-source OCR process and uses GPT-4 Vision as a last-resort fallback. This pipeline has been extensively tested, debugged, and hardened based on multiple expert audits provided by the user (impersonating ChatGPT), focusing on a zero error policy.

Production deployment issues on Render related to OpenAI API keys and private library dependencies () have been resolved. The code now uses the standard usage: openai [-h] [-v] [-b API_BASE] [-k API_KEY] [-p PROXY [PROXY ...]]
              [-o ORGANIZATION] [-t {openai,azure}]
              [--api-version API_VERSION] [--azure-endpoint AZURE_ENDPOINT]
              [--azure-ad-token AZURE_AD_TOKEN] [-V]
              {api,tools,migrate,grit} ...

positional arguments:
  {api,tools,migrate,grit}
    api                 Direct API calls
    tools               Client side tools for convenience

options:
  -h, --help            show this help message and exit
  -v, --verbose         Set verbosity.
  -b API_BASE, --api-base API_BASE
                        What API base url to use.
  -k API_KEY, --api-key API_KEY
                        What API key to use.
  -p PROXY [PROXY ...], --proxy PROXY [PROXY ...]
                        What proxy to use.
  -o ORGANIZATION, --organization ORGANIZATION
                        Which organization to run as (will use your default
                        organization if not specified)
  -t {openai,azure}, --api-type {openai,azure}
                        The backend API to call, must be `openai` or `azure`
  --api-version API_VERSION
                        The Azure API version, e.g.
                        'https://learn.microsoft.com/en-us/azure/ai-
                        services/openai/reference#rest-api-versioning'
  --azure-endpoint AZURE_ENDPOINT
                        The Azure endpoint, e.g.
                        'https://endpoint.openai.azure.com'
  --azure-ad-token AZURE_AD_TOKEN
                        A token from Azure Active Directory,
                        https://www.microsoft.com/en-
                        us/security/business/identity-access/microsoft-entra-
                        id
  -V, --version         show program's version number and exit library directly with a user-provided API key.

**Last working item**:
*   Last item agent was working: The user provided a comprehensive 20-point test checklist to validate the invoice scanning pipeline against the zero error principle. The agent was tasked with creating an automated test suite based on this checklist.
*   Status: NOT STARTED
*   Agent Testing Done: Y (The agent performed extensive manual  tests and debugging cycles on the endpoint with user-provided invoices throughout the session, successfully validating the final patched logic).
*   Which testing method agent to use? backend testing agent. The next step is to create a ============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0
rootdir: /app/frontend
plugins: anyio-4.12.1
collected 0 items

============================ no tests ran in 0.01s ============================= suite in a new file under  to automate the user's checklist.
*   User Testing Done: Y (User tested on their production app, which led to the discovery and resolution of key bugs related to API keys and parsing accuracy).

**All Pending/In progress Issue list**:
*   **Issue 1: Large Monolithic Files (P2)**
    *   **Description**: The main backend file  is still very large (~4800 lines), and the main frontend calculator file  is over 3000 lines. Both were flagged in audits as needing to be broken down for long-term stability and maintainability.
    *   **Next debug checklist**:
        *   For backend: Create a  directory and move the scan invoice endpoint logic out of  into .
        *   For frontend: Break down  into smaller, reusable React components (e.g., , , ).
    *   **Why fix this issue and what will be achieved with the fix?**: Improve code readability, maintainability, and reduce the risk of introducing bugs.
    *   **Status**: NOT STARTED
    *   **Is recurring issue?**: Y
    *   **Should Test frontend/backend/both after fix?**: both

*   **Issue 2: Frontend Development Environment Unstable (P2)**
    *   **Description**: The initial handoff mentioned recurring  and ngrok tunnel issues with the Expo development environment. This was not addressed as the focus was on the backend.
    *   **Next debug checklist**:
        1.  Check supervisor logs: .
        2.  Verify the  file and its variables.
        3.  If issues persist, restart the supervisor: frontend: ERROR (no such process)
frontend: ERROR (no such process).
    *   **Why fix this issue and what will be achieved with the fix?**: A stable frontend is required to test the end-to-end flow and implement future UI work.
    *   **Status**: NOT STARTED
    *   **Is recurring issue?**: Y
    *   **Should Test frontend/backend/both after fix?**: frontend

**In progress Task List**:
*   **Task 1: Create Comprehensive Automated Test Suite (P0)**
    *   **Where to resume**: Create a new test file (e.g., ) and implement the 20+ test cases from the user's checklist (Message #393). The tests should cover valid/invalid PDFs, good/bad images, various VIN/financial data scenarios, and edge cases. Use mock invoices where necessary.
    *   **What will be achieved with this?**: A robust test suite that guarantees the zero error requirement, prevents regressions, and validates the complex decision logic.
    *   **Status**: NOT STARTED
    *   **Should Test frontend/backend/both after fix?**: backend
    *   **Blocked on something**: None

**Upcoming and Future Tasks**
*   **(P1) Finalize Calculator-Inventory Integration:** After the test suite is built, verify on the frontend that selecting a vehicle from the inventory correctly populates its financial data (PDCO, etc.) into the calculator form in .
*   **(P2) Add Frontend Warning for VINs:** Implement a visual indicator in the review modal to highlight when a VIN has been auto-corrected or has a low validation score.
*   **(P2) Integrate Financing Programs:** Suggest relevant financing programs when a vehicle is selected from the inventory.
*   **(P3) Refactor  and :** Address Issue #1 from the pending list.
*   **(P3) Admin Dashboard for Parsing Metrics:** Create a dashboard for the admin to see parsing performance metrics (e.g., success rate, average scores, Vision fallback rate).
*   **(P3) Finalize App Store / Play Store Build Process.**

**Completed work in this session**
- **Full Backend Refactoring:** The monolithic  was broken down into a modular architecture: , , , .
- **Implemented and Hardened Multi-Layered Parsing Pipeline:** The  endpoint was completely rewritten and then patched multiple times to implement a zero error policy with a sophisticated decision engine (PDF -> OCR -> Vision fallback) based on confidence scores (85/60 thresholds).
- **Hardened Validation Rules:** Implemented a Golden Rule to block saves if critical data is invalid. Removed aggressive VIN auto-correction (forced check-digit).
- **Resolved Production Deployment Blockers:** Successfully debugged and fixed critical issues on the user's Render production environment, including invalid API keys, environment variable conflicts, and removing a private library dependency () that was causing build failures.
- **Improved GPT-4 Vision Prompt:** Optimized the prompt for higher accuracy, correcting previous data extraction errors.
- **Passed Multiple Expert Audits:** Applied numerous line-by-line patches based on detailed audits from the user's ChatGPT persona, resulting in a significantly more robust and stable system.

**Earlier issues found/mentioned but not fixed**
*   The frontend development environment's instability.
*   The need to refactor the massive  file.

**Known issue recurrence from previous fork**
*   None.

**Code Architecture**


**Key Technical Concepts**
- **Computer Vision Pipeline:** A multi-step image processing pipeline using  and .
- **Modular Refactoring:** The backend monolith was successfully broken down into feature-specific modules.
- **Defense in Depth / Multi-Layered Logic:** Using a tiered approach (PDF-native, then open-source OCR, then AI-fallback) to balance cost and accuracy.
- **Score-based Decision Logic:** A system that uses a confidence score to decide whether to auto-approve data, flag it for user review, or escalate to a more powerful (and costly) AI model.

**key DB schema**
- **inventory**: .
- **fca_product_codes**: .

**All files of reference**
- : The main orchestrator, heavily modified.
- : Created and modified.
- : Created and modified.
- : Created and modified.
- : Created and modified.
- **User Message #393:** Contains the critical test checklist that must be implemented next.

**Areas that need refactoring**:
- ****: The file is still over 4800 lines. The main scan endpoint logic should be moved to a separate file in a  directory.
- ****: A 3000+ line React Native component that is difficult to maintain.

**key api endpoints**
- : The core endpoint. It has been completely rewritten and hardened. It now accepts a file and returns a JSON object with a status (, ), the parsed vehicle data, and validation results.

**Critical Info for New Agent**
1.  **Parlez Fran√ßais:** The user is a native French speaker. All communication MUST be in French.
2.  **Implement the Test Checklist:** Your absolute top priority is to build the automated ============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0
rootdir: /app/frontend
plugins: anyio-4.12.1
collected 0 items

============================ no tests ran in 0.01s ============================= suite based on the user's detailed checklist in **Message #393**. This is non-negotiable and validates the zero error requirement.
3.  **Do Not Change Backend Logic Casually:** The backend parsing and validation pipeline has been through numerous expert audits and is considered stable. Do not alter the core decision logic (e.g., scoring thresholds, validation rules) without a very strong reason and user approval.
4.  **Production is Configured:** The agent has already debugged and configured the production environment on Render. The code uses the usage: openai [-h] [-v] [-b API_BASE] [-k API_KEY] [-p PROXY [PROXY ...]]
              [-o ORGANIZATION] [-t {openai,azure}]
              [--api-version API_VERSION] [--azure-endpoint AZURE_ENDPOINT]
              [--azure-ad-token AZURE_AD_TOKEN] [-V]
              {api,tools,migrate,grit} ...

positional arguments:
  {api,tools,migrate,grit}
    api                 Direct API calls
    tools               Client side tools for convenience

options:
  -h, --help            show this help message and exit
  -v, --verbose         Set verbosity.
  -b API_BASE, --api-base API_BASE
                        What API base url to use.
  -k API_KEY, --api-key API_KEY
                        What API key to use.
  -p PROXY [PROXY ...], --proxy PROXY [PROXY ...]
                        What proxy to use.
  -o ORGANIZATION, --organization ORGANIZATION
                        Which organization to run as (will use your default
                        organization if not specified)
  -t {openai,azure}, --api-type {openai,azure}
                        The backend API to call, must be `openai` or `azure`
  --api-version API_VERSION
                        The Azure API version, e.g.
                        'https://learn.microsoft.com/en-us/azure/ai-
                        services/openai/reference#rest-api-versioning'
  --azure-endpoint AZURE_ENDPOINT
                        The Azure endpoint, e.g.
                        'https://endpoint.openai.azure.com'
  --azure-ad-token AZURE_AD_TOKEN
                        A token from Azure Active Directory,
                        https://www.microsoft.com/en-
                        us/security/business/identity-access/microsoft-entra-
                        id
  -V, --version         show program's version number and exit library directly, and the user has provided a working API key. Be aware of the  environment variable.
5.  **Focus Shifts to Frontend Next:** After the backend test suite is complete, the focus should shift to the frontend tasks: verifying calculator integration and addressing the known refactoring needs ().

**documents and test reports created in this job**
- : A zip file of the backend modules was created for the user but is now outdated due to subsequent patches.

**Last 10 User Messages and any pending HUMAN messages**
- The user, acting as an expert auditor (ChatGPT), provided multiple, increasingly detailed sets of patches to fix structural problems and logical inconsistencies in the invoice scanning pipeline.
- The agent applied all the recommended patches, including setting stricter validation thresholds (85 for auto-approval, 60-84 for review), unifying VIN and validation logic, and fixing bugs.
- The user confirmed the agent should apply the patches.
- After all patches were applied and tested successfully, the user provided a final, comprehensive 20-point test checklist to be implemented.
- **Pending:** The user is waiting for the agent to create the automated test suite based on the provided checklist.

**Project Health Check:**
*   **Broken:**
    *   The frontend development environment is still reported as unstable.
    *   The frontend has extremely large, hard-to-maintain files (, ).
*   **Mocked:** None.

**3rd Party Integrations**
*   **OpenAI GPT-4 Vision**: Used as a fallback parser. Integrated directly via the usage: openai [-h] [-v] [-b API_BASE] [-k API_KEY] [-p PROXY [PROXY ...]]
              [-o ORGANIZATION] [-t {openai,azure}]
              [--api-version API_VERSION] [--azure-endpoint AZURE_ENDPOINT]
              [--azure-ad-token AZURE_AD_TOKEN] [-V]
              {api,tools,migrate,grit} ...

positional arguments:
  {api,tools,migrate,grit}
    api                 Direct API calls
    tools               Client side tools for convenience

options:
  -h, --help            show this help message and exit
  -v, --verbose         Set verbosity.
  -b API_BASE, --api-base API_BASE
                        What API base url to use.
  -k API_KEY, --api-key API_KEY
                        What API key to use.
  -p PROXY [PROXY ...], --proxy PROXY [PROXY ...]
                        What proxy to use.
  -o ORGANIZATION, --organization ORGANIZATION
                        Which organization to run as (will use your default
                        organization if not specified)
  -t {openai,azure}, --api-type {openai,azure}
                        The backend API to call, must be `openai` or `azure`
  --api-version API_VERSION
                        The Azure API version, e.g.
                        'https://learn.microsoft.com/en-us/azure/ai-
                        services/openai/reference#rest-api-versioning'
  --azure-endpoint AZURE_ENDPOINT
                        The Azure endpoint, e.g.
                        'https://endpoint.openai.azure.com'
  --azure-ad-token AZURE_AD_TOKEN
                        A token from Azure Active Directory,
                        https://www.microsoft.com/en-
                        us/security/business/identity-access/microsoft-entra-
                        id
  -V, --version         show program's version number and exit library. The user provides their own API key, which has been configured in the production environment.
*   **usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing.**: Primary parser for native PDF files.
*   **** (+  system package): Core open-source OCR engine.
*   ****: Used for image pre-processing.

**Testing status**
- Testing agent used after significant changes: NO
- Troubleshoot agent used after agent stuck in loop: NO
- Test files created:
    -  (exists but is basic).
    -  (created for user, now outdated).
- Known regressions: None.

**Credentials to test flow:**
- **User:** 
- **Password:** 
- **OpenAI API Key**: The user provided a working key (). It is configured on Render, but the agent may need to ask for it again for local testing.

**What agent forgot to execute**
- The agent was about to begin the primary task requested by the user: creating an automated test suite based on a detailed checklist. This is the immediate next step.
- The agent did not address the known frontend instability or refactoring tasks, as the focus was entirely on the backend pipeline.</analysis>
