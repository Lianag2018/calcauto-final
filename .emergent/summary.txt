<analysis>**original_problem_statement:**
The user wants to continue developing a mobile application for iOS and Android named CalcAuto AiPro, which functions as a comprehensive vehicle financing calculator.

The initial scope was to fix backend crashes and deploy the application. This has since expanded to include several critical features requested by the user during the development process.

**PRODUCT REQUIREMENTS:**
*   **Data Isolation (Multi-Tenancy):** Each user must only have access to their own data (contacts, submissions, etc.). (Completed)
*   **Save Submissions to Server:** Calculator submissions must be saved to the user's account. (Completed)
*   **Smart Contact Management (Upsert):** Avoid creating duplicate contacts. (Completed)
*   **Logout Functionality:** Provide a clear logout option. (Completed)
*   **Production Deployment:** Deploy the application to a live environment. (Completed on Vercel/Render)
*   **Admin Panel (P0):** An administration panel for the super-user () to view all registered users, see their activity (last login, contact count), and block/unblock their access. (Completed)
*   **Inventory Management (P0):** A system to manage vehicle inventory. (Partially Implemented)
    *   Create a database and API to store detailed vehicle information, including costs (EP, PDCO), pricing (MSRP), and status (Available, Sold). (Completed)
    -   Build a UI to view, filter, and manage the inventory. (Completed)
*   **Invoice Scanning with AI (P0):** A feature to scan a vehicle invoice (photo or PDF) and automatically populate the inventory. (In Progress)
    *   The system must use a hybrid approach: first, a structured parser (regex) for known FCA invoice formats, and if that fails, a fallback to an AI Vision model (OpenAI GPT-4o Vision).
    *   The parser must automatically decode the VIN to extract the vehicle year.
    *   The parser must use a database of FCA product codes to automatically determine the vehicle's model and trim from the base product code (e.g., ).
*   **Calculator & Inventory Integration (P1):** In the main calculator, allow the user to select a vehicle from the inventory by its stock number, which should automatically fill in the price and other details.

**User's preferred language**: French (fr). The next agent MUST respond in French.

**what currently exists?**
A full-stack application with a React Native (Expo) frontend deployed on Vercel and a FastAPI backend deployed on Render, connected to a MongoDB Atlas database.
*   **Features Completed:** Multi-tenancy, server-side submissions, contact upsert logic, logout, and production deployment are all functional.
*   **Admin Panel:** A fully functional admin panel has been implemented. The admin () can view all users, their stats, and block/unblock their accounts.
*   **Inventory Management:** The backend models and API endpoints for managing inventory are complete. The frontend has a dedicated Inventaire tab that successfully lists and allows management of vehicles.
*   **Invoice Parser Logic:** The backend contains the complete logic for the hybrid invoice parser, including VIN/product code decoders, ready to be used by the frontend.

**Last working item**:
*   Last item agent was working: Implementing the frontend for the **Invoice Scanning** feature in the Inventaire tab. The user wants to press a button, take a photo of an invoice, and have the system automatically parse it using the hybrid (Regex + AI) backend logic and add the vehicle to the inventory.
*   Status: IN PROGRESS
*   Agent Testing Done: N
*   Which testing method agent to use? Frontend testing agent. The agent needs to verify the entire flow:
    1.  The UI for uploading an image from the Inventaire screen.
    2.  The successful call to the backend endpoint .
    3.  The UI correctly updates to show the newly added vehicle after parsing.
*   User Testing Done: N

**All Pending/In progress Issue list**:
  - Issue 1: **Frontend for Invoice Scanning is Broken/Incomplete (P0)**
     - Attempted fixes: The agent added the UI code for a scan button and modal to . The  dependency was installed. However, the Expo development server started crashing/restarting in a loop right after, preventing any further progress or testing.
     - Next debug checklist:
        1.  Restart the frontend server (frontend: ERROR (no such process)
frontend: ERROR (no such process)) and check the logs () to diagnose the Expo crash loop. It may be related to the new  dependency or a syntax error.
        2.  Once the server is stable, finalize the code in . Ensure the  and  functions correctly handle image selection, send the  image data to the  endpoint, and refresh the inventory list upon success.
        3.  Use the  to get a test invoice image (like the one the user provided) to perform an end-to-end test of the feature.
     - Why fix this issue and what will be achieved with the fix?: This is the core of the new inventory automation feature requested by the user. Fixing it will allow for rapid, error-free population of the vehicle inventory.
     - Status: IN PROGRESS
     - Is recurring issue? N
     - Should Test frontend/backend/both after fix?: both
     - Blocked on other issue: None

**In progress Task List**:
- None. All work is captured in the issue above.

**Upcoming and Future Tasks**
*   **(P1) Integrate Inventory with Calculator:** Modify the calculator screen () to add a dropdown/search box where the user can select a vehicle by its  from the inventory. Selecting a vehicle should automatically populate its  and other relevant details into the calculator form.
*   **(P2) Finalize App Store / Play Store Build Process:** Prepare the app for native mobile deployment by creating build configurations and binaries (/).
*   **(P3) Refactor :** The main calculator file () is over 1800 lines long and should be broken down into smaller components.
*   **(P3) User Confirmation on Bonus Cash 3000:** The data discrepancy issue was investigated in a previous session, but the user was never explicitly shown the findings to confirm they were satisfied. This should be revisited.
*   **(P3) Copy Dev Data to Production DB (Optional):** Confirm with the user if they want to migrate any remaining data from the development environment to the production database.

**Completed work in this session**
- **Production Issues Resolved:** Fixed critical production login failures on Vercel by correcting the hardcoded backend URL.
- **Data Migration:** Successfully migrated the user's lost CRM data (815 contacts, 17 submissions) to the production MongoDB Atlas database.
- **Admin Panel Feature:** Implemented a complete, admin-only panel to view and manage application users, including blocking/unblocking access.
- **Inventory Management Feature (Phase 1):** Built the backend API and frontend UI for managing a vehicle inventory.
- **Invoice Parser Backend:** Designed and implemented the backend logic for a sophisticated hybrid invoice parser (Regex + AI) with VIN and product code enrichment capabilities.
- **Deployment Configuration:** Updated the entire codebase to point to the user's new, correct Render backend service ().

**Earlier issues found/mentioned but not fixed**
   - **Bonus Cash 3000:** This data-related issue was investigated, and the agent concluded it was not a bug. However, the user was never formally updated, and their confirmation was not received. This is tracked in Upcoming Tasks.

**Known issue recurrence from previous fork**
  - Not applicable.

**Code Architecture**


**Key Technical Concepts**
- **Frontend:** React Native (Expo), Expo Router, , React Context API.
- **Backend:** Python, FastAPI, Motor (async MongoDB), .
- **Authentication:** JWT-based with an  flag in the token payload.
- **Deployment:** Render (Backend), Vercel (Frontend), MongoDB Atlas (DB).
- **AI/ML:** Hybrid Parsing (Regex + OpenAI GPT-4o Vision) for document understanding. Data Enrichment via VIN and product code decoding.

**key DB schema**
  - **users**:  (new fields in bold).
  - **inventory**: (NEW Collection) .
  - **vehicle_options**: (NEW Collection) .

**changes in tech stack**
  - **expo-image-picker:** Added to the frontend for selecting invoice images.
  - **pdfplumber:** The chosen library for the server-side regex PDF parser.
  - **OpenAI GPT-4o Vision:** The chosen AI model for the invoice parsing fallback.

**All files of reference**
-   : Contains all new backend logic for Admin, Inventory, and Invoice Scanning.
-   : The primary file for the last worked-on feature. Needs debugging.
-   : The completed Admin Panel UI.
-   : Controls visibility of the new feature tabs.
-   : Manages user state, including the  property.

**Areas that need refactoring**:
- The file  is still extremely large (+1800 lines) and should be broken down into smaller, manageable components.

**Critical Info for New Agent**
1.  **PRIORITY:** The immediate priority is to fix the crash in the frontend  component and complete the invoice scanning feature. The user is highly engaged with this functionality.
2.  **USER COLLABORATION:** The user provides excellent, detailed technical specifications (e.g., the invoice parsing logic). Treat their input as a primary source of requirements and architecture.
3.  **ENVIRONMENT:** The production backend is . Ensure all API calls use this URL. The user has previously been confused by multiple Render services, so be clear about which one is active.
4.  **HYBRID PARSER:** The backend is ready for the hybrid parsing model (regex first, AI fallback). The frontend implementation should send the image data to  and let the backend handle the complex parsing logic.

**documents and test reports created in this job**
- None.

**Last 10 User Messages and any pending HUMAN messages**
- The user's recent messages detail a sophisticated architecture for parsing vehicle invoices, combining regex, AI, VIN decoding, and product code lookups. They are driving the design of this feature.
- : Confirmed the plan to add automatic VIN and product code decoding to enrich the data during invoice parsing. (In Progress)
- : Asked if product codes and VINs could be decoded for more vehicle details. (Answered)
- : Provided a very detailed analysis of an FCA invoice and a Python code example for a structured parser, endorsing the hybrid (regex + AI) approach. (Acknowledged)
- : Provided more context on invoice parsing and the use of OpenAI. (Acknowledged)
- : Confirmed the choices for the invoice scanning feature flow. (Acknowledged)
- : Detailed the request for an invoice scanning feature that uses the camera to automatically populate the inventory. (In Progress)
-  & : Provided extremely detailed, professional-grade specifications for the inventory database schema and business logic (e.g., how  and  should be handled). (Completed)
- : Asked for a new feature: an inventory management system where vehicles could be chosen by stock number in the calculator. (In Progress)
- : Asked if they could delete the old, confusing Render service. (Answered)

**Project Health Check:**
*   **Broken:** The Invoice Scanning UI in  is non-functional and was causing the Expo development server to crash.
*   **Mocked:** None.

**3rd Party Integrations**
*   **OpenAI GPT-4o / Vision**: For AI-based invoice parsing. Uses  environment variable.
*   **Gmail SMTP**: For sending emails.
*   **Render**: Hosts the FastAPI backend.
*   **Vercel**: Hosts the Expo web frontend.
*   **MongoDB Atlas**: Hosts the production database.
*   **GitHub**: Source code repository.

**Testing status**
  - Testing agent used after significant changes: NO (but should be used for the invoice scanning feature).
  - Troubleshoot agent used after agent stuck in loop: NO
  - Test files created: []
  - Known regressions: The Expo development server was unstable after adding the  dependency.

**Credentials to test flow:**
-   **User:** 
-   **Password:** 

**What agent forgot to execute**
- The agent failed to stabilize the frontend development environment after installing . They moved to summarize the work without resolving the Expo crash loop, leaving the invoice scanning feature in a broken state.</analysis>
