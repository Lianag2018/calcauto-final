<analysis>**original_problem_statement:**
The user wants to continue developing a mobile application for iOS and Android named CalcAuto AiPro, which functions as a comprehensive vehicle financing calculator.

The primary goal is to build an advanced inventory management system featuring automated invoice scanning. The user has rejected a simple AI-centric approach and provided detailed, evolving technical specifications for a robust, multi-layered parsing system. The latest requirement is to build a high-precision, open-source parser using computer vision techniques to avoid reliance on paid APIs.

**PRODUCT REQUIREMENTS:**
*   **Data Isolation (Multi-Tenancy):** Completed.
*   **Save Submissions to Server:** Completed.
*   **Smart Contact Management (Upsert):** Completed.
*   **Logout Functionality:** Completed.
*   **Production Deployment:** Completed.
*   **Admin Panel (P0):** Completed.
*   **Inventory Management (P0):** Partially Implemented.
    *   Database and basic API/UI: Completed.
*   **Invoice Scanning (P0):** The core task, which has undergone multiple architectural shifts. The current and final specification is:
    *   **Architecture:** A multi-layered, open-source pipeline.
    *   **Level 1 (PDFs):** Use usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing. +  for native PDF files. (Implemented)
    *   **Level 2 (Images):** Use an  +  pipeline. This involves:
        1.  Pre-processing: Automatic perspective correction (warp).
        2.  Segmentation: Detect and crop the invoice into key Regions of Interest (ROI) like VIN area, financials area, and options area.
        3.  OCR: Run  OCR on each small, clean zone individually.
        4.  Parsing: Apply the structured  parser to the combined, cleaned text.
    *   **Level 3 (Fallback):** An optimized GPT-4 Vision model should ONLY be used as a last resort if the open-source pipeline fails and produces a low confidence score.
    *   **Validation:** All parsed data must pass through a strict validation layer, including an industrial-grade VIN checksum/auto-correction module and business logic checks (e.g., ).
    *   **Review & Correct:** The final parsed data must be presented in an editable modal for user review before saving.
*   **Calculator & Inventory Integration (P1):** Partially Implemented.

**User's preferred language**: French (fr). The next agent MUST respond in French.

**what currently exists?**
A full-stack application with a React Native (Expo) frontend and a FastAPI backend using MongoDB. User authentication, an admin panel, and basic inventory management are functional.

The backend  contains a mix of parsing strategies from previous iterations, including a functional usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing. parser, a highly-optimized GPT-4 Vision parser, and a sophisticated VIN validation/auto-correction module. The agent had *started* implementing the user's latest request for an -based ROI (Region of Interest) pipeline but did not finish.

The frontend has the UI for uploading files and the review and correct modal. However, the development environment for the frontend has been unstable, frequently crashing or failing to connect.

**Last working item**:
*   Last item agent was working: Implementing the new, 100% open-source invoice parsing pipeline based on the user's latest, expert-level instructions. This pipeline uses  for image pre-processing (perspective correction) and segmentation (Region of Interest - ROI), followed by targeted  OCR on each zone, effectively replacing the direct GPT-4 Vision approach for images.
*   Status: IN PROGRESS
*   Agent Testing Done: N
*   Which testing method agent to use? both. First, the backend changes are significant. The agent should create a test script (e.g., in ) to validate the new OpenCV/Tesseract pipeline against the user-provided invoice images. Once the backend returns accurate JSON, the frontend flow (upload -> review modal) must be verified, which may require stabilizing the frontend environment first.
*   User Testing Done: N

**All Pending/In progress Issue list**:
*   **Issue 1: Invoice Parsing logic is incomplete and needs a full rewrite to the new Open-Source ROI architecture (P0)**
    *   **Attempted fixes:** The agent has built and tested several architectures (AI-only, regex-for-PDF, AI-for-image, advanced VIN correction). The last action was starting to build the OpenCV-based pipeline, but it is unfinished.
    *   **Next debug checklist**:
        1.  Review the user's detailed specification in messages #359 and #163. This is the blueprint.
        2.  Structure the backend code into a modular format as suggested: , , , , and a main .
        3.  In , implement the full pipeline:
            *   Function to load image from bytes.
            *   Function for perspective correction ( using ).
            *   Function to segment the warped image into zones ().
            *   Function to run pre-processed Tesseract OCR on each zone ().
        4.  In , orchestrate the new flow: Check if PDF -> if yes, use usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing.. If no (image) -> run the full OpenCV ROI pipeline.
        5.  The existing regex parser logic should be applied to the text extracted from the ROI pipeline.
        6.  The advanced VIN validation module must be applied to the parsed VIN.
        7.  The GPT-4 Vision code should be kept only as a final fallback.
    *   **Why fix this issue and what will be achieved with the fix?**: This will deliver the user's ultimate requirement: a highly accurate, robust, and free-to-operate invoice parser that doesn't rely on paid APIs for standard image processing.
    *   **Status**: IN PROGRESS
    *   **Is recurring issue?**: Y
    *   **Should Test frontend/backend/both after fix?**: both
    *   **Blocked on other issue**: None

*   **Issue 2: Frontend Development Environment is Unstable (P1)**
    *   **Attempted fixes:** The agent encountered multiple  and ngrok tunnel issues, identifying them as infrastructure problems but never fully resolving them.
    *   **Next debug checklist**:
        1.  Check the supervisor logs for the frontend: .
        2.  Verify the  file and its  variable.
        3.  If tunnel issues persist, try restarting the supervisor for the frontend: frontend: ERROR (no such process)
frontend: ERROR (no such process).
        4.  Investigate any errors shown in the browser console if the app loads partially.
    *   **Why fix this issue and what will be achieved with the fix?**: A stable frontend is required to test the end-to-end invoice scanning flow and any future UI work.
    *   **Status**: NOT STARTED
    *   **Is recurring issue?**: Y
    *   **Should Test frontend/backend/both after fix?**: frontend
    *   **Blocked on other issue**: None

**In progress Task List**:
*   **Task 1: Implement and Integrate the OpenCV ROI-based OCR Pipeline (P0)**
    *   **Where to resume**: Refactor  into modules, then build out the functions for perspective correction, zone segmentation, and targeted OCR as per the user's specification. Integrate this new pipeline into the  endpoint.
    *   **What will be achieved with this?**: A robust, open-source invoice parser that can handle photographed invoices with ~85-92% accuracy without API costs.
    *   **Status**: IN PROGRESS
    *   **Should Test frontend/backend/both after fix?**: both
    *   **Blocked on something**: None

**Upcoming and Future Tasks**
*   **(P1) Finalize Calculator-Inventory Integration:** After the parser is stable, test that selecting a vehicle from the inventory list in the calculator correctly populates its price into the form.
*   **(P2) Add Frontend Warning for VINs:** Implement a visual indicator in the review modal to highlight when a VIN has been auto-corrected or has a low validation score, prompting the user to double-check it.
*   **(P2) Integrate Financing Programs:** When a vehicle is selected, suggest relevant financing programs.
*   **(P3) Refactor :** Break down the massive  file (1800+ lines) into smaller, manageable components.
*   **(P3) Admin Dashboard for Parsing Metrics:** As a pro feature, create a dashboard for the admin to see parsing performance metrics (e.g., success rate of ROI vs. fallback, average confidence scores).
*   **(P3) Finalize App Store / Play Store Build Process:** Prepare native mobile builds.

**Completed work in this session**
- Implemented and validated a structured parser for native PDF invoices using usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing. and .
- Built and refined an industrial-grade VIN validation module with check-digit calculation, auto-correction for common OCR errors, and decoding of year/manufacturer.
- Prototyped and tested a GPT-4 Vision-based parser, optimizing it with image compression and specific prompts. This now serves as the last-resort fallback.
- Updated the  database to correctly decode more vehicle trims (e.g., Grand Cherokee Limited).
- Began the initial implementation of the user's final requested architecture: an open-source pipeline using OpenCV and Tesseract.

**Earlier issues found/mentioned but not fixed**
*   The frontend development environment's instability (ngrok tunnel errors, 520 errors) was noted multiple times but never fully resolved, preventing UI testing.

**Known issue recurrence from previous fork**
*   Not applicable.

**Code Architecture**

**Recommended New Backend Structure:**


**Key Technical Concepts**
- **Computer Vision Pipeline:** The new core concept is a multi-step image processing pipeline using  for geometric correction and segmentation (ROI), and  for targeted OCR.
- **Region of Interest (ROI):** The strategy of breaking a document image into smaller, specific zones for more accurate, targeted processing, rather than global processing.
- **Modular Refactoring:** The need to break the monolithic  into feature-specific modules (, , etc.) for maintainability.
- **Defense in Depth:** Using a multi-layered approach to parsing (PDF-native, then ROI-open-source, then AI-fallback) to balance cost and accuracy.

**key DB schema**
- **inventory**: . A unique index on  and  is required.
- **fca_product_codes**: . Has been updated with new codes.

**All files of reference**
- : The primary file that needs to be refactored.
- **User Message #359 (and #163):** These are the **CRITICAL** blueprints provided by the user (via ChatGPT) that detail the exact architecture, code snippets, and strategy for the new open-source ROI pipeline.

**Areas that need refactoring**:
- ****: Must be broken down into the modular structure (, , etc.) to manage complexity and align with the user's latest direction.
- ****: Remains a very large file that is difficult to maintain and should be broken into smaller components.

**key api endpoints**
- : The endpoint at the heart of the project. It needs to be rewritten to orchestrate the new multi-layered parsing pipeline (PDF check, then OpenCV ROI flow, then AI fallback).

**Critical Info for New Agent**
1.  **IMPLEMENT THE OPENCV PIPELINE:** Your absolute top priority is to build the open-source invoice parser using the  +  ROI strategy. The user has provided the exact architecture in messages #359 and #163. This replaces the previous GPT-4 Vision approach for images.
2.  **REFACTOR THE BACKEND:** As you build the new pipeline, refactor the monolithic  into the recommended modular structure (, , etc.). This is a direct, expert-level instruction from the user.
3.  **INTEGRATE EXISTING LOGIC:** The new pipeline's output must be processed by the **existing, approved** modules for regex parsing and advanced VIN validation/correction. Do not reinvent them.
4.  **STABILIZE THE FRONTEND:** The frontend dev environment has been unreliable. You will likely need to diagnose and fix it before you can perform end-to-end testing. Check supervisor logs first.
5.  **TRUST THE USER'S SPECIFICATIONS:** The user has demonstrated deep technical expertise and provided a clear, industrial-grade blueprint. Follow their final specification for the ROI pipeline precisely.

**documents and test reports created in this job**
- None mentioned.

**Last 10 User Messages and any pending HUMAN messages**
- The user provided extremely detailed, expert-level feedback (via ChatGPT) on how to build a production-ready, open-source OCR pipeline using OpenCV for Region-of-Interest segmentation, completely changing the technical strategy.
- The user then asked for progress updates (have you finished?, where are you at?, do you have a problem?), indicating they are waiting for the agent to complete this new implementation. The agent confirmed they had started but not finished.
- **Pending:** The user is waiting for the agent to complete and demonstrate the new OpenCV-based parsing pipeline.

**Project Health Check:**
*   **Broken:**
    *   The core invoice parsing logic is in the middle of a major architectural rewrite and is currently incomplete.
    *   The frontend development environment is unstable, frequently preventing the application from running.
*   **Mocked:** None.

**3rd Party Integrations**
*   **OpenAI GPT-4o / Vision**: Demoted to a last-resort fallback for invoice parsing.
*   **usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing.**: Required primary parser for native PDF files.
*   **** (+  system package): Required for the new open-source OCR engine.
*   ****: Required for the new image pre-processing and ROI pipeline.
*   **Render**: Hosts the FastAPI backend.
*   **Vercel**: Hosts the Expo web frontend.
*   **MongoDB Atlas**: Hosts the production database.

**Testing status**
- Testing agent used after significant changes: NO (not for the latest architectural changes).
- Troubleshoot agent used after agent stuck in loop: NO
- Test files created: None. It is highly recommended to create .
- Known regressions: None.

**Credentials to test flow:**
- **User:** 
- **Password:** 

**What agent forgot to execute**
- The agent has not completed the user's most recent and critical request: to build and integrate the  ROI-based open-source parsing pipeline.
- The agent has not refactored the monolithic  into a modular structure as suggested.
- The agent has not resolved the recurring instability of the frontend development environment.</analysis>
