<analysis>**original_problem_statement:**
The user wants to perfect the invoice scanning feature for their mobile application, CalcAuto AiPro. The primary goal is to achieve flawless, correctly ordered data extraction from Stellantis (FCA) invoices. Several new features have also been requested and implemented:
*   Ability to send financing submissions via SMS and a preview modal.
*   An option to Print submission details.
*   A new hybrid workflow to export OCR scan data to an Excel file for manual correction and later import, aiming for 100% data accuracy.

**PRODUCT REQUIREMENTS:**
*   **Invoice Parser Perfection (P0):** The parser logic must be fixed to preserve the exact order of vehicle options as they appear on the invoice. It frequently misorders options, especially those found via fallback logic. It also needs to correctly identify vehicle trims and filter out irrelevant text.
*   **Complete Excel Workflow (P1):** The user has approved a hybrid OCR/Excel strategy. The Export to Excel functionality is partially built. The Import from Excel feature needs to be implemented.
*   **UI/UX Bug Fixes (P1):** The new Export Excel button is not appearing in the correct location for the user, causing confusion.
*   **Code Refactoring (P2):** The monolithic files , , and  are slated for refactoring to improve maintainability.

**User's preferred language**: French. The next agent MUST respond in French.

**what currently exists?**
A full-stack application with a React Native (Expo) frontend and a FastAPI backend. The core feature is an advanced invoice scanner for vehicle financing, heavily customized for FCA invoices.

The backend  uses a multi-stage process involving regex, a description-to-code fallback dictionary, extensive skip lists, and a category-based deduplication function to clean OCR data. The frontend has been updated to include buttons for SMS sharing, printing, and exporting to Excel. Backend endpoints for exporting data to an  file have been created.

However, the application suffers from a critical, recurring bug where the invoice parser fails to maintain the correct order of vehicle options, and the newly added Export Excel button is not reliably visible to the user.

**Last working item**:
*   **Last item agent was working:** The user requested that three specific option codes (, , ) be permanently removed from all future invoice scans. The agent added these codes to the  list in  and was in the process of removing them from other data files (, ) to prevent them from being re-added by fallback logic.
*   **Status:** IN PROGRESS
*   **Agent Testing Done:** N
*   **Which testing method agent to use?** Backend testing agent. Run ============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0
rootdir: /app/frontend
plugins: anyio-4.12.1
collected 0 items

============================ no tests ran in 0.01s ============================= to check for regressions, then manually test parsing the Ram 2500 invoice to confirm the unwanted codes are gone and that this change hasn't further worsened the option ordering.
*   **User Testing Done:** N

**All Pending/In progress Issue list**:
*   **Issue 1: Incorrect Option Order (P0)**
    *   **Description:** The user has repeatedly reported that the order of vehicle options is wrong. The parser's fallback logic appears to add options to the beginning of the list instead of the end, causing items from the bottom of the invoice to appear at the top of the scan results. This is the user's number one frustration.
    *   **Attempted fixes:** The agent has tried modifying the deduplication function and adding problematic codes to a  list. These are patches that do not address the root cause.
    *   **Next debug checklist:**
        1.  In , locate the description-to-code fallback logic (the loop that uses ).
        2.  Refactor this section. Create two separate lists: one for options found by the main OCR regex () and another for options found by the fallback logic ().
        3.  After both loops complete, combine the lists: .
        4.  Pass this combined, correctly ordered list to the  function.
        5.  Test against all known invoice types (Ram, Grand Cherokee, Gladiator) to ensure order is preserved.
    *   **Why fix this issue and what will be achieved with the fix?** This is the most critical bug. Fixing it will meet the user's primary requirement for a perfect parser and resolve their main point of frustration.
    *   **Status:** IN PROGRESS
    *   **Is recurring issue?** Y
    *   **Should Test frontend/backend/both after fix?** Backend
    *   **Blocked on other issue:** None

**In progress Task List**:
*   **Task 1: Complete Removal of Unwanted Option Codes (P0)**
    *   **Where to resume:** The agent added , , and  to  in . To complete the task, these codes must also be removed from the  dictionary and the  file to prevent any possibility of them being re-introduced.
    *   **What will be achieved with this?** Fulfills the user's direct request to permanently ignore these specific codes on all invoices.
    *   **Status:** IN PROGRESS
    *   **Should Test frontend/backend/both after fix?** Backend
    *   **Blocked on something:** None.

**Upcoming and Future Tasks**
*   **(P1) Implement Excel Import:** Create the frontend UI and the backend logic for the  endpoint to allow a user to upload a corrected Excel file, which will then populate the vehicle data in the app.
*   **(P1) Fix Export Excel Button Visibility:** The user cannot find the Export Excel button. It was added to the review modal in , but it's not appearing. This needs to be debugged and fixed.
*   **(P1) Restrict Invoice Header Parsing:** A pending request to only extract the VIN from the invoice header, ignoring all other data from that section to improve accuracy.
*   **(P2) Finalize Frontend Refactoring Migration:** Execute the migration plan from  to break down the monolithic .
*   **(P2) Refactor  and :** Split these large monolithic files into smaller, more manageable modules.

**Completed work in this session**
- **Implemented Share via SMS & Print:** Added Partager par Texto and Imprimer features with a preview modal for the SMS.
- **Implemented Initial Excel Export Feature:** Created the  backend endpoint and added Exporter Excel buttons to the frontend in both  and the review modal in .
- **Fixed  Calculation:** Corrected logic in  to set , as the holdback is already factored into the E.P. value on FCA invoices.
- **Solved Parser Duplication Issue:** Implemented a  function in  using  to remove logically equivalent options and added corresponding ============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0
rootdir: /app/frontend
plugins: anyio-4.12.1
collected 0 items

============================ no tests ran in 0.01s ============================= tests.
- **Refined Parser Data & Logic:** Continuously updated parser data files and  based on user feedback on multiple real-world invoices. Removed a faulty generic mapping from  that was causing incorrect option detection.
- **Fixed Trim Detection:** Added vehicle codes (, ) to  to ensure the correct Limited and Big Horn trims are identified.

**Earlier issues found/mentioned but not fixed**
*   **Issue 1: Large Monolithic Files (, , )**
    *   **Debug checklist**: Follow the plan in  for the frontend. For the backend, plan a split of  into a  directory.
    *   **Why to solve this issue and what will be achieved with this?**: Improve code maintainability, readability, and scalability.
    *   **Should Test frontend/backend/both after fix?**: both
    *   **Is recurring issue?**: Y

**Known issue recurrence from previous fork**
*   **Issue recurrence in previous fork**: OCR/Parser Accuracy, specifically option ordering and duplicates.
*   **Recurrence count**: High
*   **Status**: IN PROGRESS. The core issue of option ordering remains unsolved and is the top priority.

**Code Architecture**


**Key Technical Concepts**
*   **Hybrid OCR/Excel Workflow:** A new strategy to combine the speed of OCR with the reliability of manual Excel validation. Export is partially built; import is next.
*   **Parser Logic Flaw:** The current implementation of the description-to-code fallback logic is the root cause of the option reordering bug. It needs to be refactored to append, not prepend, found items.
*   **Monolithic File Management:** The agent is struggling with large, complex files (, , ), which is slowing down development and introducing bugs.

**key DB schema**
- No changes.

**changes in tech stack**
-  is used on the backend for Excel file generation.

**All files of reference**
*   : The most critical file. The option ordering bug is here.
*   : Contains all API endpoints, including the new Excel endpoints.
*   : Main frontend file.
*   : Contains the Vérifier et corriger review modal where the Excel button is supposed to appear.
*   : The master database for all vehicle models and trims.
*   : The dictionary for the description-to-code fallback logic.

**Areas that need refactoring**:
*   : The  function needs to be refactored to correctly sequence OCR and fallback results to fix the ordering bug.
*   , , : These monolithic files should be broken down into smaller components/routes for maintainability.

**key api endpoints**
*   : The main endpoint for invoice parsing.
*   : **NEW** endpoint to generate an Excel file from scan data.
*   : **NEW** endpoint (stubbed) to import data from an Excel file.

**Critical Info for New Agent**
1.  **Parlez Français:** All communication with the user MUST be in French.
2.  **Fix Option Order FIRST (P0):** Your absolute top priority is to fix the incorrect ordering of vehicle options. This is the user's biggest complaint. The root cause is in the fallback logic in . Refactor it to process direct OCR results first, then append fallback results at the end.
3.  **Complete the Excel Workflow:** The user is invested in the hybrid OCR/Excel strategy. After fixing the parser, the next priority is implementing the Excel import functionality and fixing the visibility of the Export Excel button on the frontend.
4.  **Test Against All Invoices:** Any change to  must be tested against the ============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0
rootdir: /app/frontend
plugins: anyio-4.12.1
collected 0 items

============================ no tests ran in 0.01s ============================= suite and also validated against the different invoice examples the user has provided (Gladiator, Grand Cherokee, Ram 2500) to prevent regressions.

**documents and test reports created in this job**
*   

**Last 10 User Messages and any pending HUMAN messages**
The user's recent messages focus entirely on the parser's failures on a Ram 2500 invoice: incorrect option order, detection of wrong options (, ), and the absence of the Excel button. The final messages are a direct request to permanently remove specific unwanted codes (, , ) and another complaint that options from the end of the invoice are appearing at the start of the list.

**Project Health Check:**
*   **Broken:** The core invoice parser is functionally broken regarding option ordering, failing to meet the user's primary requirement. The new Excel feature is also not working correctly from the user's perspective.

**3rd Party Integrations**
*   Google Cloud Vision (OCR)
*   OpenAI GPT-4o (Fallback OCR)
*    (Excel generation)
*    (PDF parsing)

**Testing status**
*   **Testing agent used after significant changes:** No
*   **Troubleshoot agent used after agent stuck in loop:** No
*   **Test files created:**
    *    was expanded with deduplication tests.
*   **Known regressions:** The option ordering seems to have gotten worse, or at least has not been fixed, despite several attempts.

**Credentials to test flow:**
*   **User:** 
*   **Password:** 

**What agent forgot to execute**
*   The agent has consistently failed to fix the root cause of the option ordering issue, instead applying temporary patches like modifying .
*   The full Excel import/export feature loop was not completed.
*   The long-standing refactoring tasks for monolithic files have not been started.</analysis>
